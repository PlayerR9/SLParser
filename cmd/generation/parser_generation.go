package generation

import (
	ggen "github.com/PlayerR9/go-generator/generator"
)

type ParserGen struct {
	PackageName string
	Rules       map[string][]string
}

func (g *ParserGen) SetPackageName(pkg_name string) {
	g.PackageName = pkg_name
}

var (
	ParserGenerator *ggen.CodeGenerator[*ParserGen]
)

func init() {
	tmp, err := ggen.NewCodeGeneratorFromTemplate[*ParserGen]("", parser_templ)
	if err != nil {
		Logger.Fatalf("Error creating code generator: %s", err.Error())
	}

	ParserGenerator = tmp
}

const parser_templ string = `// Code generated by SlParser.
package {{ .PackageName }}

import (
	"fmt"

	grpx "github.com/PlayerR9/grammar/parser"
)

var (
	// Parser is the parser of the grammar.
	Parser *Parser[TokenType]
)

func init() {
	decision_func := func(lookahead *gr.Token[TokenType]) (grpx.Actioner, error) {
		defer p.Refuse()

		top1, ok := p.Pop()
		if !ok {
			return nil, fmt.Errorf("p.stack is empty")
		}

		var act grpx.Actioner

		switch top1.Type {
		{{- range $key, $values := .Rules }}
		case {{ $key }}:
			{{- range $index, $element := $values }}
			// {{ $element }}
			{{- end }}
		{{- end}}
		default:
			return nil, fmt.Errorf("unexpected token: %s", top1.String())
		}

		return act, nil
	}

	Parser = NewParser[TokenType](decision_func)
}
`
